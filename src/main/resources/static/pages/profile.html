<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body style="background-color: #FFF3E0; font-family: Arial, sans-serif;">
    <div id="header-placeholder"></div>

    <div style="background: linear-gradient(135deg, #FFC107, #FF5722); color: white; padding: 2rem 0; margin-bottom: 2rem;">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <img src="" alt="Profile Picture" id="profileImage" style="width: 150px; height: 150px; border-radius: 50%; border: 5px solid #FFFFFF; object-fit: cover; margin-bottom: 1rem;">
                </div>
                <div class="col-md-9">
                    <h1 id="userName" style="font-size: 2.5rem; margin-bottom: 0.5rem; color: #FFFFFF;">Loading...</h1>
                    <p id="userStatus" style="font-size: 1.25rem; color: #FFF3E0;">Member</p>
                    <button class="btn" onclick="editProfile()" style="background-color: #000000; color: #FFFFFF; border: 1px solid #000000; border-radius: 0.25rem; padding: 0.5rem 1rem; position: absolute; top: 1rem; right: 1rem;">
                        <i class="fas fa-edit" style="margin-right: 0.25rem;"></i> Edit Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-6 mb-4">
                <div style="background-color: #FFFFFF; border-radius: 15px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease;">
                    <div style="background-color: #FFF3E0; padding: 1rem; border-radius: 15px 15px 0 0;">
                        <h3 style="margin: 0; color: #000000;">
                            <i class="fas fa-user" style="margin-right: 0.5rem;"></i>Personal Information
                        </h3>
                    </div>
                    <div style="padding: 1rem;">
                        <div style="padding: 1rem; border-bottom: 1px solid #FFF3E0;">
                            <strong style="color: #000000;"><i class="fas fa-envelope" style="margin-right: 0.5rem;"></i>Email:</strong>
                            <p id="userEmail" style="margin: 0; color: #333;">Loading...</p>
                        </div>
                        <div style="padding: 1rem; border-bottom: 1px solid #FFF3E0;">
                            <strong style="color: #000000;"><i class="fas fa-phone" style="margin-right: 0.5rem;"></i>Phone Number:</strong>
                            <p id="userPhone" style="margin: 0; color: #333;">Loading...</p>
                        </div>
                        <div style="padding: 1rem; border-bottom: 1px solid #FFF3E0;">
                            <strong style="color: #000000;"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Address:</strong>
                            <p id="userAddress" style="margin: 0; color: #333;">Loading...</p>
                        </div>
                        <div style="padding: 1rem; border-bottom: 1px solid #FFF3E0;">
                            <strong style="color: #000000;"><i class="fas fa-globe" style="margin-right: 0.5rem;"></i>Country:</strong>
                            <p id="userCountry" style="margin: 0; color: #333;">Loading...</p>
                        </div>
                        <div style="padding: 1rem;">
                            <strong style="color: #000000;"><i class="fas fa-city" style="margin-right: 0.5rem;"></i>City/Location:</strong>
                            <p id="userLocation" style="margin: 0; color: #333;">Loading...</p>
                        </div>
                        <button onclick="editProfile()" style="background-color: #FFC107; color: #000000; border: 1px solid #FFC107; border-radius: 0.25rem; padding: 0.375rem 0.75rem; margin-top: 1rem; cursor: pointer; display: inline-flex; align-items: center; transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;"
                            onmouseover="this.style.backgroundColor='#FFA000'; this.style.borderColor='#FFA000';"
                            onmouseout="this.style.backgroundColor='#FFC107'; this.style.borderColor='#FFC107';">
                            <i class="fas fa-edit" style="margin-right: 0.25rem;"></i> Edit Profile
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div style="background-color: #FFFFFF; border-radius: 15px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease;">
                    <div style="background-color: #FFF3E0; padding: 1rem; border-radius: 15px 15px 0 0;">
                        <h3 style="margin: 0; color: #000000;">
                            <i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i>Account Information
                        </h3>
                    </div>
                    <div style="padding: 1rem;">
                        <div style="padding: 1rem; border-bottom: 1px solid #FFF3E0;">
                            <strong style="color: #000000;"><i class="fas fa-id-card" style="margin-right: 0.5rem;"></i>Member Since:</strong>
                            <p id="memberSince" style="margin: 0; color: #333;">Loading...</p>
                        </div>
                        <div style="padding: 1rem; border-bottom: 1px solid #FFF3E0;">
                            <strong style="color: #000000;"><i class="fas fa-star" style="margin-right: 0.5rem;"></i>Account Status:</strong>
                            <p style="margin: 0;"><span style="background-color: #FFC107; color: #000000; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">Active</span></p>
                        </div>
                        <div style="padding: 1rem;">
                            <strong style="color: #000000;"><i class="fas fa-history" style="margin-right: 0.5rem;"></i>Last Login:</strong>
                            <p id="lastLogin" style="margin: 0; color: #333;">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="logoutButton" onclick="logout()" style="background-color: #FF5722; color: #FFFFFF; border: 1px solid #FF5722; border-radius: 0.25rem; padding: 0.375rem 0.75rem; font-size: 1rem; margin: 3rem auto; display: block; cursor: pointer; transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;"
        onmouseover="this.style.backgroundColor='#E64A19'; this.style.borderColor='#E64A19';"
        onmouseout="this.style.backgroundColor='#FF5722'; this.style.borderColor='#FF5722';">
        <i class="fas fa-sign-out-alt" style="margin-right: 0.25rem;"></i> Logout
    </button>

    <div id="footer-placeholder"></div>

    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background-color: #FFFFFF;">
                <div class="modal-header" style="background-color: #FFC107; color: #000000;">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="editName" class="form-label" style="color: #000000;">Name</label>
                            <input type="text" class="form-control" id="editName" required style="border-color: #FF5722;">
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label" style="color: #000000;">Email</label>
                            <input type="email" class="form-control" id="editEmail" required style="border-color: #FF5722;">
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label" style="color: #000000;">Phone Number</label>
                            <input type="tel" class="form-control" id="editPhone" style="border-color: #FF5722;">
                        </div>
                        <div class="mb-3">
                            <label for="editAddress" class="form-label" style="color: #000000;">Address</label>
                            <input type="text" class="form-control" id="editAddress" style="border-color: #FF5722;">
                        </div>
                        <div class="mb-3">
                            <label for="editCountry" class="form-label" style="color: #000000;">Country</label>
                            <input type="text" class="form-control" id="editCountry" style="border-color: #FF5722;">
                        </div>
                        <div class="mb-3">
                            <label for="editLocation" class="form-label" style="color: #000000;">City/Location</label>
                            <input type="text" class="form-control" id="editLocation" style="border-color: #FF5722;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="background-color: #FFF3E0;">
                    <button type="button" class="btn" data-bs-dismiss="modal" style="background-color: #000000; color: #FFFFFF; border: 1px solid #000000;">Close</button>
                    <button type="button" class="btn" id="saveProfileBtn" onclick="saveProfileChanges()" style="background-color: #FF5722; color: #FFFFFF; border: 1px solid #FF5722;">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <script>
        let editProfileModalInstance;
        const API_BASE_URL = 'http://localhost:8082/users';

        function executeScripts(element) {
            const scripts = element.querySelectorAll('script');
            scripts.forEach((script) => {
                const newScript = document.createElement('script');
                if (script.src) {
                    newScript.src = script.src;
                    newScript.async = false;
                } else {
                    newScript.textContent = script.textContent;
                }
                document.head.appendChild(newScript);
                script.remove();
            });
        }

        async function loadComponents() {
            try {
                const headerResponse = await fetch('../components/header.html');
                if (!headerResponse.ok) {
                    console.error('Failed to load header:', headerResponse.status, headerResponse.statusText);
                    throw new Error('Failed to load header');
                }
                const headerHtml = await headerResponse.text();
                const headerPlaceholder = document.getElementById('header-placeholder');
                headerPlaceholder.innerHTML = headerHtml;
                executeScripts(headerPlaceholder);

                const footerResponse = await fetch('../components/footer.html');
                if (!footerResponse.ok) {
                    console.error('Failed to load footer:', footerResponse.status, footerResponse.statusText);
                    throw new Error('Failed to load footer');
                }
                document.getElementById('footer-placeholder').innerHTML = await footerResponse.text();
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        function loadUserData() {
            const userData = JSON.parse(localStorage.getItem('userData'));
            if (userData) {
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userEmail').textContent = userData.email;
                document.getElementById('userPhone').textContent = userData.phoneNumber || 'Not set';
                document.getElementById('userAddress').textContent = userData.address || 'Not set';
                document.getElementById('userCountry').textContent = userData.country || 'Not set';
                document.getElementById('userLocation').textContent = userData.location || 'Not set';
                document.getElementById('memberSince').textContent = userData.memberSince;
                document.getElementById('lastLogin').textContent = userData.lastLogin;
                if (userData.profileImage) {
                    document.getElementById('profileImage').src = userData.profileImage;
                }
            } else {
                console.warn("No user data found in localStorage. Redirecting to login.");
                window.location.href = 'login.html';
            }
        }

        function editProfile() {
            console.log("Edit button clicked");
            const userData = JSON.parse(localStorage.getItem('userData')) || {};
            console.log("Edit data", userData);

            document.getElementById('editName').value = userData.name || '';
            document.getElementById('editEmail').value = userData.email || '';
            document.getElementById('editPhone').value = userData.phoneNumber || '';
            document.getElementById('editAddress').value = userData.address || '';
            document.getElementById('editCountry').value = userData.country || '';
            document.getElementById('editLocation').value = userData.location || '';

            if (editProfileModalInstance) {
                editProfileModalInstance.show();
            } else {
                console.error("Edit profile modal instance not initialized.");
            }
        }

        async function saveProfileChanges() {
            const editForm = document.getElementById('editProfileForm');
            if (!editForm.checkValidity()) {
                editForm.reportValidity();
                return;
            }

            const currentLocalUserData = JSON.parse(localStorage.getItem('userData')) || {};
            if (!currentLocalUserData.id) {
                alert("Cannot save profile: User ID is missing. Please log in again.");
                window.location.href = 'login.html';
                return;
            }

            const updatedData = {
                id: currentLocalUserData.id,
                name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                phoneNumber: document.getElementById('editPhone').value,
                address: document.getElementById('editAddress').value,
                country: document.getElementById('editCountry').value,
                location: document.getElementById('editLocation').value,
            };

            console.log("Attempting to save updated data:", updatedData);

            try {
                const response = await fetch(`${API_BASE_URL}/${updatedData.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedData)
                });

                const responseData = await response.json();

                if (response.ok) {
                    console.log("Profile update successful, backend response:", responseData);
                    localStorage.setItem('userData', JSON.stringify(responseData.user));
                    loadUserData();
                    if (editProfileModalInstance) {
                        editProfileModalInstance.hide();
                    }
                    alert('Profile updated successfully!');
                } else {
                    console.error('Failed to update profile:', response.status, response.statusText, responseData.message);
                    alert('Failed to update profile: ' + (responseData.message || 'An unknown error occurred.'));
                }
            } catch (error) {
                console.error('Error during profile update network request:', error);
                alert('An error occurred while updating profile. Please check your network and try again.');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('userData');
                localStorage.removeItem('authToken');
                sessionStorage.removeItem('userSession');
                window.location.href = 'login.html';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const modalElement = document.getElementById('editProfileModal');
            if (modalElement) {
                editProfileModalInstance = new bootstrap.Modal(modalElement);
            } else {
                console.error("Edit Profile Modal element not found!");
            }

            const saveButton = document.getElementById('saveProfileBtn');
            if (saveButton) {
                saveButton.addEventListener('click', saveProfileChanges);
            } else {
                console.error("Save Profile Button (saveProfileBtn) not found!");
            }

            loadUserData();
            loadComponents();
        });
    </script>
</body>
</html>